---
title: "MultipleImputation_SpecificGravity"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Install and load required packages
```{r}
install.packages("mice")
install.packages("lubridate")
library(lubridate)
library(haven)
library(mice)
library(data.table)
library(ggplot2)
```

## Set path and import data
```{r}
path = '/Users/dewate01/Desktop/PROGRESS_SpecificGravity_MultipleImputation/PROGRESS_SpecificGravity_MultipleImputation'
setwd(path)
SG_data = read.csv('ERIK_NIA_SG_imp_oct10_2018.csv')
```

##compute season of collection date to control for seasonal variation in data collection. First convert the date into a single number, and then compute the sine and cosine of time as indexes of season
```{r}
date = mdy(SG_data$fecha_control)
days = yday(date) 

SG_data$time.sin = sinpi(2 * (days - 1)/(365 +max(days, na.rm = T) - 1))
SG_data$time.cos = cospi(2 * (days - 1)/(365 +max(days, na.rm = T) - 1))
```

## create an average variable that represents the geometric mean of 5 phthalates that are weakly correlated with each other (as recommendended by Dr. Alan Just). Associations between this average phthalates variable and specific gravity will later be explored
```{r}
#create natural log of phtalates of interest
SG_data$mEP2_Conc_ngml_l <- log(SG_data$mEP2_Conc_ngml)
SG_data$mBP_Conc_ngml_l <- log(SG_data$mBP_Conc_ngml)
SG_data$miBP_Conc_ngml_l <- log(SG_data$miBP_Conc_ngml)
SG_data$mBzP2_Conc_ngml_l <- log(SG_data$mBzP2_Conc_ngml)
SG_data$mECPP_Conc_ngml_l <- log(SG_data$mECPP_Conc_ngml)

#create exponential function then create variable which is geometric mean
e <- exp(1) 
SG_data$phthalates <-e^(rowMeans(SG_data[, c("mEP2_Conc_ngml_l", "mBP_Conc_ngml_l", "miBP_Conc_ngml_l", 
                                               "mBzP2_Conc_ngml_l", "mECPP_Conc_ngml_l")]))
```

##linear regression analyses, regressing covariates and phthalates (geometric mean of 5 phthalates) on specific gravity. These analyses are performed to check whether phthalates and covariates are linearly associated with specific gravity. Covariates were selected after consulting a clinician (NAME???) who is an expert on phthalates.  
```{r}
lm_BMI = lm(SG_data$SG ~ SG_data$mother_bmi)
summary(lm_BMI)
lm_MatAge = lm(SG_data$SG ~ SG_data$mothers_age)
summary(lm_MatAge)
lm_GestAge = lm(SG_data$SG ~ SG_data$gest_age_weeks)
summary(lm_GestAge)
lm_Phthalates = lm(SG_data$SG ~ SG_data$phthalates)
summary(lm_Phthalates) 
lm_time.sin = lm(SG_data$SG ~ SG_data$time.sin)
summary(lm_time.sin)
lm_time.cos = lm(SG_data$SG ~ SG_data$time.cos)
summary(lm_time.cos)
lm_PhthalatesCovariates = lm(SG_data$SG ~ SG_data$phthalates + SG_data$mother_bmi + SG_data$mothers_age + SG_data$gest_age_weeks + SG_data$time.sin + SG_data$time.cos)
summary(lm_PhthalatesCovariates)
```

##Check distribution of specific gravity. Check for normal distribution and outliers
```{r}
#plot a histogram to check distribution
ggplot(data = SG_data, aes(x = SG, fill = "Red")) +geom_histogram()

#compute mean and SD and check whether there are SG values >3 SD's above/below mean
mean_SG = mean(SG_data$SG, na.rm =T)
sd_SG = sd(SG_data$SG, na.rm =T)
SD3_below = mean_SG - (3*sd_SG)
SD3_above = mean_SG + (3*sd_SG)
minSG = min(SG_data$SG, na.rm=T)
maxSG = max(SG_data$SG, na.rm=T)
SG_data$SG_outlier [SG_data$SG> SD3_above] <-1
SG_data$SG_outlier [SG_data$SG< SD3_above] <-0
#remove outliers from dataset (one subject, folio 380, with biologically impossible value)
SG_data = SG_data[is.na(SG_data$SG) | SG_data$SG < SD3_above,]

```

##Use mice package to perform multiple imputation analyses (10 iterations)
```{r}
#call the mice package
init = mice(SG_data, maxit=0) 
meth = init$method
predM = init$predictorMatrix

#indicate the variables that will be removed as predictors
predM[, c("SG", "folio")]=0


#specify the predictors (norm = continuous variables)
meth[c("phthalates")]="norm"
meth[c("mothers_age")]="norm"
meth[c("mother_bmi")]="norm"
meth[c("gest_age_weeks")]="norm"
meth[c("time.cos")]="norm"
meth[c("time.sin")]="norm"

#perform mi analyses with pmm method
set.seed(103)
imputed_pmm = mice(SG_data, method='pmm', predictorMatrix=predM, m=10)
imputed_pmm <- complete(imputed_pmm)

#Check for missing data in the imputed dataset.
sapply(imputed_pmm, function(x) sum(is.na(x)))

#convert to data table
class(imputed_pmm)
imputed_pmm<-as.data.table(imputed_pmm)


#Density Plot of Original and Imputed Specific Gravity
plot(density(imputed_pmm$SG), col="blue", 
     xlab="Specific Gravity", #Change the x-axis label
     ylab="Density", #y-axis label
     main="Density Plot of Original and Imputed Specific Gravity")#Main title
lines(density(SG_sub$SG, na.rm=TRUE), col="red")
legend(1.04, 50, legend=c("Original SG", "Imputed SG"),
       col=c("red", "blue"), lwd=1:1, cex=0.8,
       title="SG Type", text.font=4, bg='white')


```

